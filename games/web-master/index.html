<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web Master</title>
    <script src="lib/codemirror.js"></script>
    <link rel="stylesheet" href="lib/codemirror.css">
    <script type="text/javascript"
            src="mode/xml/xml.js"></script>
    <script type="text/javascript"
            src="mode/htmlmixed/htmlmixed.js"></script>
    <script type="text/javascript"
            src="mode/javascript/javascript.js"></script>
    <script src="http://codemirror.net/addon/hint/show-hint.js"></script>
    <script src="http://codemirror.net/addon/hint/javascript-hint.js"></script>
    <script src="http://codemirror.net/addon/hint/xml-hint.js"></script>
    <script src="http://codemirror.net/addon/hint/html-hint.js"></script>
    <script src="https://unpkg.com/esprima@~4.0/dist/esprima.js"></script>
</head>
<body>

<style>
    html, body {
        height: 100%;
        background-color: moccasin;
        overflow: hidden;
    }

    body * {
        box-sizing: border-box;
        margin: 0;
    }
    main {
        display: grid;
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
        height: 100%;
    }

    .view {
        background-color: whitesmoke;
        display: grid;
        grid-template-columns: 300px auto;

    }

    .controls {
        background-color: red;
        display: grid;
        grid-template-columns: 1fr;
        grid-template-rows: auto;
    }

    .controls button {
        flex: 1;
    }



    .instructions {
        background-color: black;
        color: white;
        text-align: center;
        padding: .4em;
    }

    #world {
        background-color: deepskyblue;
    }





</style>

<main>

    <div class="view">

        <div class="instructions">

        </div>
        <div id="world">

        </div>

    </div>
    <div class="controls">
        <!--<div id="html">-->
            <!--HTML-->
        <!--</div>-->
        <div style="display: flex; ">
            <button onclick="run()">Run</button><button onclick="resetHtml()">Reset</button>
        </div>
        <div id="javascript">
            JavaScript
        </div>
    </div>
</main>


<script>
    // const html1 = createCM(document.querySelector('#html'), 'html', 'html1');
    const js1 = createCM(document.querySelector('#javascript'), 'js', 'js1');
    const world = document.querySelector('#world');
    // html1.on('keyup', this.changeDetectedCm);
    // html1.on('mousedown', this.mouseDownDetectedCm);
    js1.on('keyup', this.changeDetectedCm);
    js1.on('mousedown', this.mouseDownDetectedCm);

    function createCM(el, type, name) {
        const htmlConfig = {
            lineNumbers: true,
            extraKeys: {
                "Ctrl-Space": "autocomplete"
            },
            mode: "text/html"
        };
        const jsConfig = {
            lineNumbers: true,
            extraKeys: {
                "Ctrl-Space": "autocomplete"
            },
            mode: {
                name: "javascript",
                globalVars: true
            }
        };
        const cm = CodeMirror(el, type === 'html' ? htmlConfig : jsConfig);
        cm.changeDetectedCm = changeDetectedCm;
        cm.mouseDownDetectedCm = mouseDownDetectedCm;
        cm.cmName = name;
        return cm;
    }

    function changeDetectedCm(e, cm) {
    }

    function mouseDownDetectedCm(e, cm) {
    }
</script>
<!--ready-->
<script>

    let scene = 0;
    let shouldTest = false;
    const game = {
        instructions : 'hello',
    };


    const instructions = document.querySelector('.instructions');


    const sequence = [
        {
            instructions: 'Hello...',
            wait: 2000,
            startingHTML : 'hello',
        },
        {
            instructions: 'Wake up!!',
            startingHTML: 'hello',
            wait: 3000,
        },
        {
            instructions: 'We need your help. From this world I can only communicate with you through javascript.',
            test: test,
            startingHTML: 'world',
            answer: function answer(vars) {
                console.log('answer', vars.answer);
                if (vars.answer === true) {
                    console.log('yep');
                    moveToNextScene();
                } else {
                    console.log('nope');
                }
            }
        },
        {
            instructions: 'you did it',
            answer: 'test',
        }
    ];
    function gameLoop() {
        handleScene();
        window.requestAnimationFrame(gameLoop);
    }
    gameLoop();

    function handleScene() {
        if (sequence[scene].wait) {
            if (sequence[scene].start) {
                if (new Date() - sequence[scene].start > sequence[scene].wait ) {
                    moveToNextScene()
                } else {
                    console.log('no', sequence[scene].start - new Date());
                }
            } else {
                sequence[scene].start = new Date();
            }
        } else if (sequence[scene].test) {
            if (shouldTest === true) {
                sequence[scene].test();
                shouldTest = false;
            }

        }
        handleInstructions();
    }

    function handleInstructions() {
        instructions.innerHTML = sequence[scene].instructions;
    }

    function moveToNextScene() {
        scene++;
        if (scene >= sequence.length) {
            scene = 0;
        }
        if (sequence[scene].startingHTML) {
            document.getElementById('world').innerHTML = sequence[scene].startingHTML;
        } else  {
            sequence[scene].startingHTML =  document.getElementById('world').innerHTML;
        }
        js1.setValue('');
    }

    function resetHtml() {
        if (sequence[scene].startingHTML) {
            document.getElementById('world').innerHTML = sequence[scene].startingHTML;
        } else {
            document.getElementById('world').innerHTML = '';
        }
    }

    function run() {
        shouldTest = true;
    }


    function test() {
        let str = js1.getValue();
        const mapObj = {
            'const' : 'window.',
            'let' : "window."
        };
        str = str.replace(/\s/g, '');
        str = str.replace('document.body', 'document.getElementById(`world`)');
        str = str.replace(/const|let/gi, function(matched){
            return mapObj[matched];
        });
        try {
            console.log(str, this.last)
            if (str === this.last) {return}
            console.log('ran');
            this.last = str;
            eval(str);
            var result = esprima.parse(str);
            console.log('result', result);
            var vars = result.body.map( v => {
                console.log(v.expression);
                if (!v.expression || v.expression && !v.expression.left) {
                    return null;
                }
                return [v.kind, v.expression.left.property.name]
            });
            vars = vars.filter( i => i);
            var testObj = {};

            vars.forEach( v => {
                testObj[v[1]] = window[v[1]];
            })

        } catch (e) {
            console.log('error', e);
        }

        if (vars) {
            this.answer(testObj);
        }
    }
</script>
</body>
</html>